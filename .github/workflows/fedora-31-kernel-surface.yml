name: Fedora 31 - kernel-surface

on: [push]

jobs:
  build:
    name: Build Kernel
    runs-on: ubuntu-latest
    container: fedora:31
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Decrypt certificates
      env:
        LS_PASSWORD: ${{ secrets.LS_PASSWORD }}
      run: |
        pushd pkg/secrets
          ./decrypt.sh -p "$LS_PASSWORD" -f gpg/surface_gpg.key.gpg
          ./decrypt.sh -p "$LS_PASSWORD" -f sb/surface_sb.key.gpg
        popd
    - name: Install certificates
      run: |
        gpg --no-tty --batch --yes --import pkg/secrets/gpg/surface_gpg.key
        cp pkg/secrets/sb/surface_sb.key pkg/fedora/kernel-surface/surface.key
        cp pkg/secrets/sb/surface_sb.crt pkg/fedora/kernel-surface/surface.crt
    - name: Install build dependencies
      run: |
        dnf install -y rpmdevtools findutils openssl openssl-devel kmod   \
          patch bash tar git-core sbsigntools bzip2 xz findutils gzip m4  \
          diffutils perl-interpreter perl-Carp perl-devel perl-generators \
          make gawk gcc binutils redhat-rpm-config hmaccalc bison flex    \
          net-tools hostname bc elfutils-devel python3-devel rpm-sign
    - name: Build packages
      run: |
        pushd pkg/fedora/kernel-surface
          ../makerpm -sk linux-surface
        popd
    - name: Upload artifacts
      uses: actions/upload-artifact@v1
      with:
        name: kernel-surface-fc31
        path: pkg/fedora/kernel-surface/out/x86_64
